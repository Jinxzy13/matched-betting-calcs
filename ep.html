<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Extra Place Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#04394a; --bg2:#021e28;
      --panel:#002d3c; --line:#0e586d;
      --ink:#e6faff; --accent:#7ce3f0;
      --btn1:#16b7c5; --btn2:#109aa6;
      --win:#2ed47a; --loss:#ff6b6b;
      --muted:rgba(230,250,255,0.75);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Ubuntu',sans-serif;
      background:radial-gradient(circle at 50% 30%,var(--bg1),var(--bg2) 80%);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .topnav{
      background:rgba(0,0,0,0.25);
      padding:.4rem .8rem;
      border-bottom:1px solid rgba(255,255,255,0.15);
      margin-bottom:1rem;
      text-align:center;
      border-radius:0 0 8px 8px;
      width:100%;
      max-width:1100px;
    }
    .topnav a{
      color:#7ce3f0;
      margin:0 .8rem;
      text-decoration:none;
      font-weight:500;
      font-size:.9rem;
    }
    .topnav a:hover{text-decoration:underline;}
    .topnav a.active{
      text-decoration:underline;
      font-weight:700;
    }

    .wrap{
      background:rgba(0,45,60,.92);
      border-radius:16px;
      border:1px solid var(--line);
      width:min(1100px,96vw);
      padding:1.1rem 1.4rem 1.4rem;
      box-shadow:0 0 40px rgba(0,0,0,.45);
      margin:1rem auto 1.5rem;
    }
    h1{
      margin:.1rem 0 .25rem;
      color:var(--accent);
      font-size:1.6rem;
      text-align:center;
    }
    .sub{
      text-align:center;
      font-size:.9rem;
      color:var(--muted);
      margin-bottom:.9rem;
    }

    .grid-2{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:1rem;
    }
    @media (max-width:860px){
      .grid-2{grid-template-columns:1fr;}
    }
    .grid-3{
      display:grid;
      grid-template-columns:2fr 1.2fr 1.2fr;
      gap:.75rem;
      margin-bottom:.75rem;
    }
    @media (max-width:780px){
      .grid-3{grid-template-columns:1fr;}
    }

    fieldset{
      border-radius:12px;
      border:1px solid var(--line);
      padding:.85rem .9rem 1rem;
      background:rgba(4,57,74,.8);
      min-width:0;
    }
    legend{
      padding:0 .3rem;
      font-weight:600;
      color:var(--accent);
      font-size:.98rem;
    }
    label{
      display:block;
      font-size:.86rem;
      margin:.35rem 0;
    }
    .small-label{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:var(--muted);
      margin-bottom:.18rem;
      display:block;
    }
    input, select{
      width:100%;
      border-radius:6px;
      border:1px solid #094a5d;
      background:#032733;
      color:var(--ink);
      padding:.4rem .55rem;
      font-family:inherit;
      font-size:.95rem;
    }
    input[readonly]{
      background:#021c25;
      opacity:.95;
    }
    .inline{
      display:flex;
      gap:.35rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .inline span{font-size:.86rem;}
    .pill{
      display:inline-block;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.3);
      padding:.08rem .45rem;
      font-size:.75rem;
      color:var(--muted);
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.35rem;
      border:none;
      border-radius:999px;
      padding:.5rem 1.3rem;
      font-size:.9rem;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(180deg,var(--btn1),var(--btn2));
      color:#00252b;
    }
    .btn:hover{filter:brightness(1.05);}
    .btn.secondary{
      background:transparent;
      color:var(--ink);
      border:1px solid rgba(124,227,240,.6);
    }
    .btn.tiny{
      padding:.25rem .6rem;
      font-size:.78rem;
      border-radius:999px;
    }

    .steps{
      margin:.5rem 0 1rem;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(2,30,40,.95);
      padding:.6rem .75rem .75rem;
    }
    .steps-row{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:.45rem;
    }
    @media (max-width:900px){
      .steps-row{grid-template-columns:1fr;}
    }
    .step{
      background:rgba(0,45,60,.95);
      border-radius:10px;
      border:1px solid rgba(14,88,109,.9);
      padding:.4rem .55rem .55rem;
      font-size:.86rem;
    }
    .step-title{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      opacity:.8;
      margin-bottom:.25rem;
    }
    .step strong{font-weight:700;}

    .outcomes{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:.55rem;
      margin-top:.6rem;
    }
    @media (max-width:800px){
      .outcomes{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    .oc{
      background:rgba(0,0,0,.2);
      border-radius:10px;
      border:1px solid rgba(14,88,109,.9);
      padding:.35rem .45rem .5rem;
      text-align:center;
      font-size:.9rem;
    }
    .oc-title{
      font-size:.86rem;
      margin-bottom:.15rem;
    }
    .oc-val{
      font-size:1rem;
      font-weight:700;
      margin-top:.15rem;
    }
    .oc-val.win{color:var(--win);}
    .oc-val.loss{color:var(--loss);}

    .implied{
      margin-top:.7rem;
      font-size:.9rem;
      text-align:center;
      color:var(--muted);
    }
    .implied strong{color:var(--accent);}

    .buttons-row{
      margin-top:.8rem;
      display:flex;
      flex-wrap:wrap;
      gap:.55rem;
      justify-content:space-between;
      align-items:center;
    }
    .note{
      font-size:.78rem;
      color:var(--muted);
      margin-top:.35rem;
      text-align:center;
    }

    /* HELPER PANEL STYLES */
    .helper{
      margin-top:.75rem;
      border-radius:12px;
      border:1px solid rgba(124,227,240,.5);
      background:rgba(1,24,33,.95);
      padding:.7rem .8rem .85rem;
      font-size:.86rem;
    }
    .helper-title{
      font-size:.9rem;
      font-weight:600;
      color:var(--accent);
      margin-bottom:.35rem;
    }
    .helper-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:.5rem;
      margin-bottom:.4rem;
    }
    @media (max-width:900px){
      .helper-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media (max-width:650px){
      .helper-grid{grid-template-columns:1fr;}
    }
    .helper-summary{
      display:flex;
      flex-direction:column;
      gap:.15rem;
      color:var(--muted);
    }
    .helper-summary span.value{
      color:var(--accent);
      font-weight:600;
    }
  </style>
</head>
<body>

<div class="topnav">
    <a href="index.html">Main Calculator</a>
    <a href="oddsmatcher.html">Odds Matcher</a>
    <a href="refund.html">Risk Free</a>
    <a href="acca.html">Acca</a>
    <a href="ep.html" class="active">Extra Place</a>
    <a href="early.html">Early Payout</a>
    <a href="betbuilder.html">Bet Builder</a>
</div>

<div class="wrap">
  <h1>Extra Place Calculator</h1>
  <div class="sub">
    Each way extra place for horse racing. Enter your back bet and win/place lays,
    then use the copy buttons to send stakes to the exchange. Implied odds show the
    value of the extra place compared with your qualifying result.
  </div>

  
  <div class="grid-3">
    <label>
      <span class="small-label">Race (time &amp; course)</span>
      <input id="race" type="text" placeholder="e.g. 14:55 Newbury" />
    </label>
    <label>
      <span class="small-label">Horse</span>
      <input id="horse" type="text" placeholder="e.g. Moon Dorange" />
    </label>
    <label>
      <span class="small-label">Bookmaker / Exchange</span>
      <input id="bookie" type="text" placeholder="e.g. Paddy Power / Betdaq" />
    </label>
  </div>

  <div class="grid-2">
    
    <fieldset>
      <legend>Each Way Back Bet (Bookmaker)</legend>

      <label>
        <span class="small-label">Back odds (dec)</span>
        <input id="backOdds" type="number" step="0.01" min="1.01" value="51">
      </label>

      <label>
        <span class="small-label">Total each way stake (£)</span>
        <input id="totalStake" type="number" step="1" min="0" value="4">
      </label>

      <label>
        <span class="small-label">Place payout fraction</span>
        <div class="inline">
          <input id="placeNum" type="number" step="1" min="1" value="1" style="max-width:4rem;">
          <span>/</span>
          <input id="placeDen" type="number" step="1" min="1" value="5" style="max-width:4rem;">
        </div>
      </label>

      <label>
        <span class="small-label">Implied each way place odds (bookie)</span>
        <input id="placeOddsDisplay" type="text" readonly>
      </label>
    </fieldset>

    
    <fieldset>
      <legend>Lay Bets (Exchange)</legend>

      <label>
        <span class="small-label">Lay the WIN – odds</span>
        <input id="layWinOdds" type="number" step="0.01" min="1.01" value="75">
      </label>

      <label>
        <span class="small-label">Lay the WIN – commission (%)</span>
        <input id="layWinComm" type="number" step="0.01" min="0" value="0">
      </label>

      <label>
        <span class="small-label">Lay the PLACE – odds</span>
        <input id="layPlaceOdds" type="number" step="0.01" min="1.01" value="15.5">
      </label>

      <label>
        <span class="small-label">Lay the PLACE – commission (%)</span>
        <input id="layPlaceComm" type="number" step="0.01" min="0" value="0">
      </label>
    </fieldset>
  </div>

  
  <div class="steps">
    <div class="steps-row">
      <div class="step">
        <div class="step-title">Step 1</div>
        <div id="step1Text">
          BACK £… each way with the bookmaker.
        </div>
      </div>
      <div class="step">
        <div class="step-title">Step 2</div>
        <div class="inline" style="justify-content:space-between;align-items:flex-start">
          <div id="step2Text">
            LAY THE WIN for £… at odds of …
          </div>
          <button class="btn tiny secondary" type="button" id="copyLayWin">Copy stake</button>
        </div>
      </div>
      <div class="step">
        <div class="step-title">Step 3</div>
        <div class="inline" style="justify-content:space-between;align-items:flex-start">
          <div id="step3Text">
            LAY THE PLACE for £… at odds of …
          </div>
          <button class="btn tiny secondary" type="button" id="copyLayPlace">Copy stake</button>
        </div>
      </div>
    </div>

    <div class="outcomes">
      <div class="oc">
        <div class="oc-title">Won</div>
        <div class="pill">Horse wins</div>
        <div class="oc-val" id="plWin">£0.00</div>
      </div>
      <div class="oc">
        <div class="oc-title">Placed</div>
        <div class="pill">Standard place</div>
        <div class="oc-val" id="plPlace">£0.00</div>
      </div>
      <div class="oc">
        <div class="oc-title">Lost</div>
        <div class="pill">No place</div>
        <div class="oc-val" id="plLose">£0.00</div>
      </div>
      <div class="oc">
        <div class="oc-title">Extra Place</div>
        <div class="pill">Finishes in extra place only</div>
        <div class="oc-val" id="plExtra">£0.00</div>
      </div>
    </div>

    <div class="implied">
      Implied odds for the <strong>extra place</strong> are:
      <strong id="impliedOdds">∞</strong>
    </div>
  </div>

  
  <div class="helper">
    <div class="helper-title">Extra place value helper</div>
    <div class="helper-grid">
      <label>
        <span class="small-label">Number of runners</span>
        <input id="runners" type="number" min="0" step="1" placeholder="e.g. 20">
      </label>
      <label>
        <span class="small-label">Total places paid</span>
        <input id="totalPlaces" type="number" min="0" step="1" placeholder="e.g. 5">
      </label>
      <label>
        <span class="small-label">Extra places</span>
        <input id="extraPlaces" type="number" min="1" step="1" placeholder="e.g. 1">
      </label>
    </div>
    <div class="helper-summary">
      <div>
        Fair implied odds from field size (runners × 1.5 ÷ extra places) ≈
        <span id="fairIo" class="value">–</span>
      </div>
      <div>
        Your bet implied odds (from staking) =
        <span id="betIo" class="value">–</span>
      </div>
      <div id="ioVerdict">
        Enter race info and recalc to see if this looks +EV.
      </div>
    </div>
  </div>
  

  <div class="buttons-row">
    <div>
      <button type="button" class="btn" id="recalcBtn">Recalculate</button>
    </div>
    <div class="inline">
      <button type="button" class="btn secondary" id="saveBetBtn">Save bet</button>
      <span class="note" style="margin:0;text-align:left;">
        Saved via <code>save_bet.php</code> as bet type <strong>extra_place</strong>.
      </span>
    </div>
  </div>

  <div class="note">
    Implied odds in the main panel are calculated as
    (extra place uplift vs worst normal outcome ÷ qualifying loss) + 1.  
    If there is no qualifying loss (all non-extra outcomes are profitable), the
    calculator shows ∞ implied odds.
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);

  const backOddsEl     = $('backOdds');
  const totalStakeEl   = $('totalStake');
  const placeNumEl     = $('placeNum');
  const placeDenEl     = $('placeDen');

  const layWinOddsEl   = $('layWinOdds');
  const layWinCommEl   = $('layWinComm');
  const layPlaceOddsEl = $('layPlaceOdds');
  const layPlaceCommEl = $('layPlaceComm');

  const placeOddsDisplayEl = $('placeOddsDisplay');

  const step1TextEl = $('step1Text');
  const step2TextEl = $('step2Text');
  const step3TextEl = $('step3Text');

  const plWinEl   = $('plWin');
  const plPlaceEl = $('plPlace');
  const plLoseEl  = $('plLose');
  const plExtraEl = $('plExtra');
  const impliedEl = $('impliedOdds');

  const raceEl   = $('race');
  const horseEl  = $('horse');
  const bookieEl = $('bookie');

  // HELPER ELEMENTS
  const runnersEl     = $('runners');
  const totalPlacesEl = $('totalPlaces');
  const extraPlacesEl = $('extraPlaces');
  const fairIoEl      = $('fairIo');
  const betIoEl       = $('betIo');
  const ioVerdictEl   = $('ioVerdict');

  let lastCalc = null; // store for saving & helper

  function money(x){
    if (!isFinite(x)) return '0.00';
    return (Math.round(x*100)/100).toFixed(2);
  }

  function recalc(){
    const Ob   = parseFloat(backOddsEl.value)   || 0;
    const T    = parseFloat(totalStakeEl.value) || 0;
    const pn   = parseFloat(placeNumEl.value)   || 0;
    const pd   = parseFloat(placeDenEl.value)   || 1;

    const Lw   = parseFloat(layWinOddsEl.value)   || 0;
    const Lp   = parseFloat(layPlaceOddsEl.value) || 0;
    const cW   = (parseFloat(layWinCommEl.value)   || 0) / 100;
    const cP   = (parseFloat(layPlaceCommEl.value) || 0) / 100;

    if (Ob <= 1 || T <= 0 || pn <= 0 || pd <= 0 || Lw <= 1 || Lp <= 1 || (Lw - cW) <= 0 || (Lp - cP) <= 0){
      placeOddsDisplayEl.value = '';
      step1TextEl.textContent = 'BACK £… each way with the bookmaker.';
      step2TextEl.textContent = 'LAY THE WIN for £… at odds of …';
      step3TextEl.textContent = 'LAY THE PLACE for £… at odds of …';
      [plWinEl,plPlaceEl,plLoseEl,plExtraEl].forEach(el => {
        el.textContent = '£0.00';
        el.classList.remove('win','loss');
      });
      impliedEl.textContent = '∞';
      lastCalc = null;
      updateHelper();
      return;
    }

    const S_each = T / 2;
    const f = pn / pd;

    const placeOdds = 1 + f * (Ob - 1);
    placeOddsDisplayEl.value = placeOdds.toFixed(2);

    const B_win   = S_each * (1 + f) * (Ob - 1);
    const B_place = -S_each + S_each * f * (Ob - 1);
    const B_lose  = -2 * S_each;

    const denomP = (Lp - cP);
    const y_raw = (B_place - B_lose) / denomP;

    const denomW = (Lw - cW);
    const x_raw = ((B_win - B_lose) - y_raw*denomP) / denomW;

    // Lay stakes (keep our exact maths here)
    const layWinStake   = x_raw;
    const layPlaceStake = y_raw;

    const Liw = (Lw - 1) * layWinStake;
    const Lip = (Lp - 1) * layPlaceStake;

    const ex_win   = -Liw - Lip;
    const ex_place = layWinStake*(1 - cW) - Lip;
    const ex_lose  = layWinStake*(1 - cW) + layPlaceStake*(1 - cP);
    const ex_extra = ex_lose;

    const totWin   = B_win   + ex_win;
    const totPlace = B_place + ex_place;
    const totLose  = B_lose  + ex_lose;
    const totExtra = B_place + ex_extra;

    step1TextEl.innerHTML =
      `BACK <strong>£${money(S_each)}</strong> each way ` +
      `(£${money(T)} total stake) with the bookmaker at odds of <strong>${Ob}</strong>.`;

    step2TextEl.innerHTML =
      `LAY THE WIN for <strong>£${money(layWinStake)}</strong> ` +
      `with the exchange at odds of <strong>${Lw}</strong> – ` +
      `liability will be <strong>£${money(Liw)}</strong>.`;

    step3TextEl.innerHTML =
      `LAY THE PLACE for <strong>£${money(layPlaceStake)}</strong> ` +
      `with the exchange at odds of <strong>${Lp}</strong> – ` +
      `liability will be <strong>£${money(Lip)}</strong>.`;

    function updateOutcome(el, val){
      const n = +val || 0;
      el.textContent = (n >= 0 ? '£' : '−£') + money(Math.abs(n));
      el.classList.remove('win','loss');
      el.classList.add(n >= 0 ? 'win' : 'loss');
    }
    updateOutcome(plWinEl,   totWin);
    updateOutcome(plPlaceEl, totPlace);
    updateOutcome(plLoseEl,  totLose);
    updateOutcome(plExtraEl, totExtra);

    const baseMin = Math.min(totWin, totPlace, totLose);
    const qualLoss = baseMin < 0 ? -baseMin : 0;
    const extraProfit = totExtra - baseMin;

    let impliedText = '∞';
    let impliedNumeric = Infinity;
    if (qualLoss > 0 && extraProfit > 0){
      const implied = 1 + (extraProfit / qualLoss);
      impliedText = implied.toFixed(2);
      impliedNumeric = implied;
    }

    impliedEl.textContent = impliedText;

    lastCalc = {
      Ob, T, pn, pd,
      Lw, Lp, cW: cW*100, cP: cP*100,
      S_each,
      placeOdds,
      layWinStake, layPlaceStake,
      Liw, Lip,
      totWin, totPlace, totLose, totExtra,
      baseMin,
      implied: impliedText,
      impliedNumeric
    };

    updateHelper();
  }

  // HELPER LOGIC
  function updateHelper(){
    const runners = parseFloat(runnersEl.value) || 0;
    const extra   = parseFloat(extraPlacesEl.value) || 0;

    const betIO = (lastCalc && isFinite(lastCalc.impliedNumeric))
      ? lastCalc.impliedNumeric
      : null;

    // Always show bet IO if we have it
    if (betIO){
      betIoEl.textContent = betIO.toFixed(2);
    } else {
      betIoEl.textContent = '–';
    }

    if (runners <= 0 || extra <= 0){
      fairIoEl.textContent = '–';
      ioVerdictEl.textContent =
        'Enter runners & extra places (and recalc) to compare against field-size fair odds.';
      return;
    }

    const fairIO = runners * 1.5 / extra;
    fairIoEl.textContent = fairIO.toFixed(2);

    if (!betIO || !isFinite(betIO)){
      ioVerdictEl.textContent = 'Recalculate the bet to see your implied odds.';
      return;
    }

    const diff = betIO - fairIO;
    const multiple = betIO / fairIO;

    let verdict;
    if (betIO > fairIO){
      verdict = `✅ Positive value: your IO is about ${multiple.toFixed(2)}× fair (edge ≈ ${diff.toFixed(2)} odds).`;
    } else if (Math.abs(diff) < 0.5){
      verdict = `⚖️ Roughly break-even: your IO is about ${multiple.toFixed(2)}× fair.`;
    } else {
      verdict = `❌ Below fair: your IO is only ${multiple.toFixed(2)}× fair (short by about ${Math.abs(diff).toFixed(2)} odds).`;
    }
    ioVerdictEl.textContent = verdict;
  }

  async function saveToServer(entry){
    const res = await fetch('save_bet.php', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(entry)
    });
    return res.json();
  }

  async function handleSave(){
    if (!lastCalc){
      alert('Please calculate the bet first.');
      return;
    }
    const c = lastCalc;

    const race  = (raceEl.value || '—').trim();
    const horse = (horseEl.value || '').trim();
    const bkEx  = (bookieEl.value || '—').trim();

    let bookieName = bkEx;
    let exchangeName = '';
    if (bkEx.includes('/')){
      const parts = bkEx.split('/');
      bookieName   = parts[0].trim();
      exchangeName = parts.slice(1).join('/').trim();
    }

    const entry = {
      event:   race || 'Extra place race',
      outcome: horse
        ? `${horse} (extra place, implied ${c.implied})`
        : `Extra place (implied ${c.implied})`,

      bookie:   bookieName || '—',
      exchange: exchangeName || '—',

      betType: 'extra_place',
      noLay:   0,

      stake:        Number(c.T),
      backOdds:     Number(c.Ob),
      layOdds:      Number(c.Lw),
      commissionPct:Number(c.cW),
      layStake:     Number(c.layWinStake),

      backWins: Number(c.totExtra), // EP lands
      layWins:  Number(c.baseMin),  // worst non-extra
      expectedPL: Number(c.baseMin)
    };

    try{
      await saveToServer(entry);
      alert('Bet saved to database as extra place bet.');
    }catch(err){
      console.error(err);
      alert('There was a problem saving this bet.');
    }
  }

  function copyText(txt){
    if (!navigator.clipboard){
      alert('Clipboard API not available in this browser.');
      return;
    }
    navigator.clipboard.writeText(txt).catch(err => console.error(err));
  }

  $('recalcBtn').addEventListener('click', recalc);
  ['backOdds','totalStake','placeNum','placeDen','layWinOdds','layWinComm','layPlaceOdds','layPlaceComm']
    .forEach(id => {
      const el = $(id);
      el.addEventListener('input', recalc);
      el.addEventListener('change', recalc);
    });

  $('copyLayWin').addEventListener('click', () => {
    if (!lastCalc) return;
    copyText(money(lastCalc.layWinStake));
  });
  $('copyLayPlace').addEventListener('click', () => {
    if (!lastCalc) return;
    copyText(money(lastCalc.layPlaceStake));
  });

  $('saveBetBtn').addEventListener('click', handleSave);

  // Helper inputs watch their own changes
  [runnersEl, totalPlacesEl, extraPlacesEl].forEach(el => {
    el.addEventListener('input', updateHelper);
    el.addEventListener('change', updateHelper);
  });

  // initial calculation
  recalc();
</script>
</body>
</html>
